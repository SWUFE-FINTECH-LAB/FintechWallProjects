# Wind 市场墙板 – 开发指南

## 1. 概述与范围
- **目标**: 提供一个 1 分钟循环、多场景的市场情报墙板，即时了解全球市场概况。
- **外形**: 16:9 4K 横向显示器 (55–65英寸)，以信息亭模式运行，自动启动和自动重新连接。
- **场景轮换**: 五个场景 (A–E) 每 20–45 秒循环一次；完整循环 ≤ 60 秒。顺序和停留时间根据活跃的交易时段进行调整。
- **目标用户**: 需要快速了解情况而无需手动交互的交易台、教室或简报室。
- **变体**:
  - **Wind 版** – 使用 WindPy/WAPI 作为权威数据源，并以开放/免费的源作为备份。
  - **开放版** – 仅使用非商业性开放或免费 API；必须可在没有 Wind 访问权限的情况下部署，同时保持相同的 UI/UX 体验。

## 2. 产品变体
### 2.1 共同原则
- 各版本具有相同的用户体验、布局和场景逻辑。
- 统一的有效负载模式，因此前端和轮播逻辑保持不变。
- 通过配置 (`DATA_MODE=wind|open`) 选择版本，并可针对每个指标进行测试覆盖。
- 两个版本都维护按 `source` 键控的 Redis 缓存，从而实现并行操作。

### 2.2 Wind 版
- **主要来源**: WindPy/WAPI，用于全球指数、期货主连、外汇、利率、宏观日历、行业分类和隐含波动率指标。
- **备用**: 在允许的情况下使用公共 API（例如，用于加密货币的 CoinGecko，用于美国收益率的 FRED）。
- **凭证处理**: 需要 Wind 终端凭证；安排保持活动的心跳以防止会话过期。

### 2.3 开放版
- **主要来源**: 公共/非商业数据提供商，例如雅虎财经、Stooq、Twelve Data、ECB、AlphaVantage、FRED、美国财政部、MAS、CME FedWatch CSV、CoinGecko、币安/OKX 和官方 RSS 源。
- **限制**: 遵守归属/许可要求；某些端点有速率限制或延迟数据。
- **备用**: 替代的免费源或缓存的最后已知值，以保持与 Wind 版的对等性。

## 3. 场景要求
### 场景 A – 全球概览 (当前)
- **内容**:
  - 股票: 标普 500、纳斯达克 100、欧洲斯托克 50、日经 225、恒生、上证 50、NIFTY 50、STI。
  - 商品/能源: WTI、布伦特、黄金、白银、铜、铁矿石 (主连)。
  - 外汇: DXY、USD/JPY、EUR/USD、USD/CNH、USD/SGD。
  - 利率: 美国 2 年期和 10 年期、德国 10 年期、日本 10 年期、新加坡 10 年期，以及 2s10s 倒挂标志。
  - 加密货币: BTC、ETH、SOL 价格和 24 小时变化，USDT/USDC 优势。
  - 市场状态: 交易所开/关指示器，带有本地时间和新加坡时间。
- **Wind 版来源**: Wind `wsq`/`wsd`/`wsi` 端点。
- **开放版来源**: 雅虎财经或 Stooq 用于指数，CME/Quandl/EIA 用于商品，ECB 和 AlphaVantage 用于外汇，FRED/财政部/MAS 用于利率，CoinGecko 用于加密货币。

### 场景 B – 股票热图
- **热图**: 全球或区域 (美国/欧盟/亚太地区) 热图，其中颜色 = 每日回报，大小 = 成交额或权重。
- **涨跌幅榜**: 前 10 名上涨/下跌股，带有流动性过滤器 (市值和成交量阈值)。
- **波动率面板**: VIX、VXN 值以及 1 个月与 3 个月隐含波动率期限结构迷你图。
- **Wind 版来源**: Wind 行业分类和成交额数据，通过 Wind 的隐含波动率指数。
- **开放版来源**: ETF 持股数据集、公共部门基准、Stooq/雅虎成交量、CBOE 发布的 VIX/VXN (延迟) 和公共期限结构 CSV。

### 场景 C – 宏观与利率
- **收益率曲线**: 美国、德国、日本、新加坡曲线，与前一周进行比较着色。
- **政策预期**: CME 联邦基金期货隐含的下一次 FOMC 会议的概率。
- **参考利率**: SOFR、SORA (以及可选的 SHIBOR 以供参考)。
- **经济日历**: 即将到来的 24–72 小时事件，带有倒计时、前值/共识/实际值字段。
- **Wind 版来源**: Wind 宏观日历、收益率曲线和参考利率。
- **开放版来源**: 美国财政部每日收益率曲线、ECB/德意志联邦银行发布、日本财务省、MAS/ABS 用于 SORA/SOR、CME FedWatch CSV、Investing.com/ForexFactory RSS 或 iCal 源 (受条款约束)。

### 场景 D – 加密货币深度
- **现货指标**: BTC/ETH/SOL 价格、24 小时变化和年化已实现波动率快照。
- **衍生品**: 来自主要交易所的永续资金费率和未平仓合约 (聚合视图)。
- **稳定币流向**: USDT/USDC 进出交易所的净流向。
- **链上活动**: 1-2 个指标 (例如，活跃地址、转账量)。
- **来源**: 用于现货/波动率的 CoinGecko REST；用于资金和未平仓合约的币安、OKX、Coinbase WebSocket 流；公共链上 API (Glassnode 社区端点或自计算) – 适用于两个版本。

### 场景 E – 新闻横幅 (可选)
- **内容**: 仅标题的行情自动收录器，用于中央银行讲话、主要收益、预定事件；可选的事件倒计时替代。
- **许可**: 无文章正文。使用官方 RSS 源 (中央银行、交易所、路透社/雅虎标题源) 或依赖日历事件以避免版权问题。
- **Wind 版**: 如果合同权利允许，则使用 Wind 标题源。
- **开放版**: 带有归属的 RSS/Atom 提取。

### 场景时间和权重
- 默认轮换 ≤ 60 秒；每个会话的场景停留时间可配置。
- 会话:
  - 亚洲 (07:00–13:00 SGT): 强调亚太地区股票和利率。
  - 欧洲 (13:00–20:00 SGT): 强调欧洲资产。
  - 美国 (20:00–02:00 SGT): 强调美国股票、国债、加密货币。
  - 隔夜 (02:00–07:00 SGT): 优先考虑宏观日历和加密货币。
- 如果数据过时超出 SLA，则在重试刷新时保持当前场景，并带有“上次更新 HH:MM”徽章。

## 4. 用户体验与布局
- **网格**: 三列布局加上顶部跑马灯。
  - 顶部: 滚动行情自动收录器，循环显示指数、外汇、商品、加密货币亮点。
  - 左侧: 英雄价格卡片 (≥ 60–80 像素数字)，带有 ▲▼ 符号。
  - 中间: 热图或迷你图 (火花线、烛台图)。
  - 右侧: 收益率摘要、资金费率、日历图块。
- **设计语言**: 蓝色/橙色调色板，适合色盲人士；高对比度火花线；有限的网格线。
- **市场状态**: 小绿/灰点加上本地和 SGT 时间。
- **交互**: 信息亭模式，无用户控件，预设时间后自动进入深色模式。
- **可访问性**: 使用针对远距离可读性优化的字体；根据 WCAG AA 保持对比度。

## 5. 数据源矩阵
| 指标 | Wind 版主要来源 | Wind 版备用来源 | 开放版主要来源 | 开放版备用来源 | 说明 |
| --- | --- | --- | --- | --- | --- |
| 全球指数 | Wind `wsq` | 雅虎财经 API | 雅虎财经 / Stooq | Twelve Data / Tiingo (免费增值) | 检查速率限制和许可 |
| 期货和商品 | Wind `wsd` (主连) | Quandl (CME), EIA | Quandl 免费数据集, CME CSV | Investing.com 抓取 (如果条款允许) | 铁矿石通过 DCE 主连；验证可用性 |
| 外汇快照 | Wind 实时 | ECB 参考利率 | ECB 参考, AlphaVantage FX | Dukascopy JSON | 转换为 SGT；注意延迟 |
| 利率和曲线 | Wind 收益率端点 | FRED / 财政部 | 财政部, ECB, MAS | Investing.com CSV | 如果需要，计算曲线插值 |
| 经济日历 | Wind 日历 | 手动 CSV | Investing.com / ForexFactory 源 | 自定义策划的 Google 表格 | 验证版权 |
| 行业数据 | Wind 行业树 | ETF 持股 CSV | 来自公共 ETF 的 GICS 等效数据 | 手动映射 | 为热图预计算 |
| 隐含波动率 | Wind 指数 | CBOE CSV | CBOE 发布的数据 | AlphaVantage 波动率系列 | 可接受延迟报价 |
| 加密货币现货 | CoinGecko | 币安 REST | CoinGecko | Coinbase REST | 跨版本共享 |
| 资金和 OI | 币安/OKX WebSocket | Deribit WebSocket | 币安/OKX WebSocket | Coinalyze (如果允许) | 按交易所聚合 |
| 稳定币流向 | 计算得出 (Wind 辅助) | Glassnode (付费) | 链上 API (例如，CryptoQuant 免费, Nansen lite) | 自计算 ETL | 考虑构建 ETL |
| 新闻标题 | Wind 新闻 (如果获得许可) | RSS 源 | RSS/Atom 源 | 日历事件 | 仅存储标题、时间和来源 |

## 6. 系统架构
### 6.1 高级组件
- **数据提取服务 (Python)**:
  - 运行 Wind 适配器 (Wind 版) 或开源适配器 (开放版)。
  - 按资产类别安排拉取作业；规范化为共享模式。
  - 将有效负载写入 Redis，并带有版本控制和时间戳。
- **实时流服务 (Node/TypeScript)**:
  - 管理 WebSocket 订阅 (加密货币、高频外汇)。
  - 聚合流，应用退避，并将合并的 WebSocket 广播到前端。
- **REST/GraphQL API**: 公开用于低频数据 (日历、热图) 的缓存快照。
- **前端 (React + Vite + Tailwind)**:
  - 渲染场景，处理轮播计时、信息亭全屏、离线缓存。
  - 消费与版本无关的 REST/WebSocket 端点。
- **配置模块**:
  - 环境驱动的版本切换、会话计划、刷新间隔。
- **监控和日志记录**:
  - 带有源元数据、延迟和错误代码的结构化日志。
  - 每个服务的健康端点；可选的 Grafana 仪表板。

### 6.2 部署
- 通过 Docker Compose 或 Kubernetes (可选) 编排的容器化服务。
- 信息亭主机 (迷你 PC / 树莓派) 在信息亭模式下运行 Chromium，并带有自动启动脚本。
- 用于缓存有效负载的持久卷，以便在网络中断时实现热重启。

## 7. 数据刷新和弹性
- **刷新频率**:
  - 现货外汇和加密货币: 5–15 秒。
  - 利率、隐含波动率、热图: 1–5 分钟。
  - 经济日历: 即将到来时 60 分钟，事件发生前 2 小时内 1–5 分钟。
  - 新闻行情自动收录器: 30–60 秒。
- **备用工作流**:
  1. 在 SLA 内尝试主要来源。
  2. 超时后，调用备用来源。
  3. 如果备用失败，则显示带有“过时”徽章和时间戳的缓存值。
- **错误处理**:
  - 检测异常值 (z-score 阈值) 并进行限制或标记。
  - 在 API 响应中公开上次成功更新时间。
- **持久性**:
  - 将最后一个有效负载存储到磁盘；在启动时加载。
  - 保留每个场景的 TTL 配置以避免过度获取。

## 8. 数据建模
- **规范有效负载 (JSON)**:
  - `indices`, `commodities`, `fx`, `rates`, `crypto`, `calendar`, `heatmap`, `volTerm`, `stablecoinFlows`, `news`, `metadata`。
  - 每个条目包括 `code`, `label`, `value`, `changePct`, `timestamp`, `source`。
  - `metadata` 包括版本 (`wind`/`open`)、刷新时间戳、许可说明。
- **历史数组**: 为火花线和期限结构可视化提供迷你系列 (`spark`) 数组。
- **日历项目**: `event`, `importance`, `time_local`, `time_sgt`, `previous`, `consensus`, `actual`, `status` (`upcoming|released`)。
- **热图模型**: 分层行业 → 产业 → 代码，带有 `weight`, `changePct`, `turnover`。

## 9. 实施路线图
1. **基础**
   - 设置代码库结构、通用配置、Redis 实例。
   - 为场景 A 指标实现带有 Wind 和开放实现的提供程序抽象。
2. **数据覆盖范围扩展**
   - 为场景 B–E 数据添加模块；连接加密货币 WebSocket 聚合。
   - 实现备用链和缓存策略。
3. **前端 MVP**
   - 使用模拟数据构建布局网格、跑马灯、场景外壳和轮播控制器。
4. **视觉增强**
   - 集成 Lightweight Charts/ECharts 用于热图/收益率曲线/波动率期限结构。
   - 添加稳定币流向可视化和风险警报横幅 (例如，VIX 或 2s10s 倒挂)。
5. **会话调度和主题**
   - 实现按时间加权、自动深色模式和信息亭首选项。
6. **弹性和监控**
   - 模拟 API 中断；验证备用行为；添加日志记录/警报。
7. **打包和交付**
   - 创建部署脚本、信息亭自动启动配置和管理文档。

## 10. 测试和验证
- **单元测试**: 提供程序适配器、模式验证、转换实用程序。
- **集成测试**: 使用模拟 API 响应对两个版本进行获取 → 规范化 → 缓存流。
- **UI 测试**: 场景布局的快照测试、视觉回归检查。
- **故障转移测试**: 模拟主要来源中断 (Wind 服务器关闭、API 速率限制) 以确保备用和过时指示器触发。
- **性能测试**: 验证 4K 分辨率下的 WebSocket 吞吐量和浏览器渲染。

## 11. 运营注意事项
- **凭证**: 使用环境变量或机密管理器安全地存储 Wind 凭证 (Wind 版) 和 API 密钥 (开放版)。
- **归属**: 在页脚或设置叠加层中显示每个版本的数据源免责声明。
- **维护**: 安排作业以刷新会话计划规则 (假期) 和更新符号列表。
- **合规性**: 审查公共 API 的许可，以确保允许显示；维护数据使用情况的审计跟踪。

## 12. 风险和悬而未决的问题
- **许可**: 确认 Wind 数据和每个开放 API 的再分发权利 (许多禁止商业显示)。
- **数据完整性**: 开放版可能缺少某些指标 (例如，铁矿石连续合约)；定义可接受的替代品或明确的遗漏。
- **日历可靠性**: 开放来源可能会滞后；考虑对关键事件进行手动覆盖。
- **WebSocket 限制**: 确保币安/OKX 允许长时间的信息亭连接；计划重新连接/退避。
- **版本漂移**: 建立自动回归测试，以便 UI 在开放版中优雅地处理缺失的指标。

## 13. 附录
- **A. 关键 API**:
  - WindPy `wsq`, `wsi`, `wsd`, 宏观日历端点。
  - CoinGecko `/simple/price`, `/coins/{id}/market_chart`。
  - 币安期货 WebSocket 流 (`bookTicker`, `fundingRate`, `openInterest`)。
  - FRED `/series/observations` 用于利率。
  - 美国财政部收益率曲线 CSV。
  - ECB 参考利率 JSON。
  - CBOE VIX/VXN CSV 下载链接。
  - CME FedWatch CSV 用于概率。
- **B. 配置示例**:
  ```json
  {
    "dataMode": "wind",
    "sessionSchedule": [
      { "name": "Asia", "start": "07:00", "end": "13:00", "scenes": {"A": 25, "B": 20, "C": 20, "D": 20, "E": 15} },
      { "name": "Europe", "start": "13:00", "end": "20:00", "scenes": {"A": 25, "B": 25, "C": 20, "D": 15, "E": 15} },
      { "name": "US", "start": "20:00", "end": "02:00", "scenes": {"A": 25, "B": 25, "C": 20, "D": 20, "E": 10} },
      { "name": "Overnight", "start": "02:00", "end": "07:00", "scenes": {"A": 20, "B": 15, "C": 30, "D": 25, "E": 10} }
    ],
    "refreshIntervals": {
      "fx": 10,
      "crypto": 10,
      "rates": 120,
      "calendar": 300,
      "news": 45
    }
  }
  ```
- **C. 术语表**:
  - **SLA** – 服务水平协议，用于数据新鲜度。
  - **OI** – 未平仓合约。
  - **SORA/SOFR** – 新加坡/美国隔夜无风险利率。
  - **2s10s 倒挂** – 美国国债 2 年期收益率减去 10 年期收益率为负的情况，触发风险标志。